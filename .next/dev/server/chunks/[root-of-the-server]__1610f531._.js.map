{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/G/Desktop/SavinGCs/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport bcrypt from 'bcryptjs';\r\n\r\nconst dbPath = join(process.cwd(), 'savings-tracker.db');\r\nconst db = new Database(dbPath);\r\n\r\n// Enable foreign keys\r\ndb.pragma('foreign_keys = ON');\r\n\r\n// Initialize database with schema\r\nexport function initializeDatabase() {\r\n  const schema = readFileSync(join(process.cwd(), 'lib', 'schema.sql'), 'utf-8');\r\n  db.exec(schema);\r\n\r\n  // Migration: add owner column if it doesn't exist\r\n  const cols = db.prepare(\"PRAGMA table_info(accounts)\").all() as { name: string }[];\r\n  if (!cols.some(c => c.name === 'owner')) {\r\n    db.exec(\"ALTER TABLE accounts ADD COLUMN owner TEXT NOT NULL DEFAULT 'Joint'\");\r\n    console.log('Migration: added owner column to accounts');\r\n  }\r\n\r\n  // Create default users if they don't exist\r\n  const userCount = db.prepare('SELECT COUNT(*) as count FROM users').get() as { count: number };\r\n\r\n  if (userCount.count === 0) {\r\n    const salt = bcrypt.genSaltSync(10);\r\n    const defaultPassword = bcrypt.hashSync('loveyou', salt);\r\n\r\n    db.prepare(`\r\n      INSERT INTO users (username, password_hash, display_name)\r\n      VALUES (?, ?, ?)\r\n    `).run('gary', defaultPassword, 'Gary');\r\n\r\n    db.prepare(`\r\n      INSERT INTO users (username, password_hash, display_name)\r\n      VALUES (?, ?, ?)\r\n    `).run('catherine', defaultPassword, 'Catherine');\r\n\r\n    console.log('Created default users: gary and catherine');\r\n  }\r\n\r\n  // Ensure 'Unallocated' pot always exists (highest priority so it sorts first)\r\n  const unallocated = db.prepare(\"SELECT id FROM savings_pots WHERE name = 'Unallocated'\").get() as any;\r\n  if (!unallocated) {\r\n    db.prepare(`\r\n      INSERT INTO savings_pots (name, goal_amount, color, icon, priority)\r\n      VALUES ('Unallocated', NULL, '#64748B', 'savings', 9999)\r\n    `).run();\r\n    console.log('Created default pot: Unallocated');\r\n  }\r\n\r\n  console.log('Database initialized successfully');\r\n}\r\n\r\n// Initialize on import\r\ninitializeDatabase();\r\n\r\nexport default db;\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAA,yGAAI,EAAC,QAAQ,GAAG,IAAI;AACnC,MAAM,KAAK,IAAI,qNAAQ,CAAC;AAExB,sBAAsB;AACtB,GAAG,MAAM,CAAC;AAGH,SAAS;IACd,MAAM,SAAS,IAAA,6GAAY,EAAC,IAAA,yGAAI,EAAC,QAAQ,GAAG,IAAI,OAAO,eAAe;IACtE,GAAG,IAAI,CAAC;IAER,kDAAkD;IAClD,MAAM,OAAO,GAAG,OAAO,CAAC,+BAA+B,GAAG;IAC1D,IAAI,CAAC,KAAK,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK,UAAU;QACvC,GAAG,IAAI,CAAC;QACR,QAAQ,GAAG,CAAC;IACd;IAEA,2CAA2C;IAC3C,MAAM,YAAY,GAAG,OAAO,CAAC,uCAAuC,GAAG;IAEvE,IAAI,UAAU,KAAK,KAAK,GAAG;QACzB,MAAM,OAAO,qKAAM,CAAC,WAAW,CAAC;QAChC,MAAM,kBAAkB,qKAAM,CAAC,QAAQ,CAAC,WAAW;QAEnD,GAAG,OAAO,CAAC,CAAC;;;IAGZ,CAAC,EAAE,GAAG,CAAC,QAAQ,iBAAiB;QAEhC,GAAG,OAAO,CAAC,CAAC;;;IAGZ,CAAC,EAAE,GAAG,CAAC,aAAa,iBAAiB;QAErC,QAAQ,GAAG,CAAC;IACd;IAEA,8EAA8E;IAC9E,MAAM,cAAc,GAAG,OAAO,CAAC,0DAA0D,GAAG;IAC5F,IAAI,CAAC,aAAa;QAChB,GAAG,OAAO,CAAC,CAAC;;;IAGZ,CAAC,EAAE,GAAG;QACN,QAAQ,GAAG,CAAC;IACd;IAEA,QAAQ,GAAG,CAAC;AACd;AAEA,uBAAuB;AACvB;uCAEe"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/G/Desktop/SavinGCs/app/api/accounts/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport db from '@/lib/db';\r\n\r\nexport async function GET(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    try {\r\n        const { id } = await params;\r\n\r\n        const account = db.prepare(`\r\n      SELECT a.*, sp.name as pot_name, sp.color as pot_color\r\n      FROM accounts a\r\n      JOIN savings_pots sp ON sp.id = a.pot_id\r\n      WHERE a.id = ?\r\n    `).get(id) as any;\r\n\r\n        if (!account) {\r\n            return NextResponse.json({ error: 'Account not found' }, { status: 404 });\r\n        }\r\n\r\n        // Get balance history for this account\r\n        const history = db.prepare(`\r\n      SELECT balance, recorded_date, created_at\r\n      FROM balance_history\r\n      WHERE account_id = ?\r\n      ORDER BY recorded_date DESC, created_at DESC\r\n      LIMIT 50\r\n    `).all(id);\r\n\r\n        // Get transaction count for integrity warning\r\n        const txCount = db.prepare(\r\n            'SELECT COUNT(*) as count FROM transactions WHERE account_id = ?'\r\n        ).get(id) as { count: number };\r\n\r\n        return NextResponse.json({ account, history, transactionCount: txCount.count });\r\n    } catch (error) {\r\n        console.error('Error fetching account:', error);\r\n        return NextResponse.json({ error: 'Failed to fetch account' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function PATCH(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    try {\r\n        const { id } = await params;\r\n        const { accountName, accountType, owner, currentBalance } = await request.json();\r\n\r\n        // Get existing account for comparison\r\n        const existing = db.prepare('SELECT * FROM accounts WHERE id = ?').get(id) as any;\r\n        if (!existing) {\r\n            return NextResponse.json({ error: 'Account not found' }, { status: 404 });\r\n        }\r\n\r\n        const today = new Date().toISOString().split('T')[0];\r\n\r\n        // Use a transaction to maintain integrity\r\n        db.transaction(() => {\r\n            // Update account fields\r\n            db.prepare(`\r\n        UPDATE accounts \r\n        SET account_name = ?, account_type = ?, owner = ?, current_balance = ?, last_updated = CURRENT_TIMESTAMP\r\n        WHERE id = ?\r\n      `).run(\r\n                accountName ?? existing.account_name,\r\n                accountType ?? existing.account_type,\r\n                owner ?? existing.owner,\r\n                currentBalance ?? existing.current_balance,\r\n                id\r\n            );\r\n\r\n            // If balance changed, log to balance_history\r\n            if (currentBalance !== undefined && currentBalance !== existing.current_balance) {\r\n                db.prepare(`\r\n          INSERT INTO balance_history (account_id, balance, recorded_date)\r\n          VALUES (?, ?, ?)\r\n        `).run(id, currentBalance, today);\r\n            }\r\n        })();\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            balanceChanged: currentBalance !== undefined && currentBalance !== existing.current_balance,\r\n            previousBalance: existing.current_balance,\r\n            newBalance: currentBalance ?? existing.current_balance\r\n        });\r\n    } catch (error) {\r\n        console.error('Error updating account:', error);\r\n        return NextResponse.json({ error: 'Failed to update account' }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function DELETE(\r\n    request: NextRequest,\r\n    { params }: { params: Promise<{ id: string }> }\r\n) {\r\n    try {\r\n        const { id } = await params;\r\n        // CASCADE will handle deleting related transactions and balance_history\r\n        db.prepare('DELETE FROM accounts WHERE id = ?').run(id);\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        console.error('Error deleting account:', error);\r\n        return NextResponse.json({ error: 'Failed to delete account' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEO,eAAe,IAClB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACA,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QAErB,MAAM,UAAU,6IAAE,CAAC,OAAO,CAAC,CAAC;;;;;IAKhC,CAAC,EAAE,GAAG,CAAC;QAEH,IAAI,CAAC,SAAS;YACV,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,uCAAuC;QACvC,MAAM,UAAU,6IAAE,CAAC,OAAO,CAAC,CAAC;;;;;;IAMhC,CAAC,EAAE,GAAG,CAAC;QAEH,8CAA8C;QAC9C,MAAM,UAAU,6IAAE,CAAC,OAAO,CACtB,mEACF,GAAG,CAAC;QAEN,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE;YAAS;YAAS,kBAAkB,QAAQ,KAAK;QAAC;IACjF,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACJ;AAEO,eAAe,MAClB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACA,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QACrB,MAAM,EAAE,WAAW,EAAE,WAAW,EAAE,KAAK,EAAE,cAAc,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE9E,sCAAsC;QACtC,MAAM,WAAW,6IAAE,CAAC,OAAO,CAAC,uCAAuC,GAAG,CAAC;QACvE,IAAI,CAAC,UAAU;YACX,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,MAAM,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAEpD,0CAA0C;QAC1C,6IAAE,CAAC,WAAW,CAAC;YACX,wBAAwB;YACxB,6IAAE,CAAC,OAAO,CAAC,CAAC;;;;MAIlB,CAAC,EAAE,GAAG,CACI,eAAe,SAAS,YAAY,EACpC,eAAe,SAAS,YAAY,EACpC,SAAS,SAAS,KAAK,EACvB,kBAAkB,SAAS,eAAe,EAC1C;YAGJ,6CAA6C;YAC7C,IAAI,mBAAmB,aAAa,mBAAmB,SAAS,eAAe,EAAE;gBAC7E,6IAAE,CAAC,OAAO,CAAC,CAAC;;;QAGpB,CAAC,EAAE,GAAG,CAAC,IAAI,gBAAgB;YACvB;QACJ;QAEA,OAAO,uKAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,gBAAgB,mBAAmB,aAAa,mBAAmB,SAAS,eAAe;YAC3F,iBAAiB,SAAS,eAAe;YACzC,YAAY,kBAAkB,SAAS,eAAe;QAC1D;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAClF;AACJ;AAEO,eAAe,OAClB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACA,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QACrB,wEAAwE;QACxE,6IAAE,CAAC,OAAO,CAAC,qCAAqC,GAAG,CAAC;QACpD,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC7C,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAClF;AACJ"}}]
}